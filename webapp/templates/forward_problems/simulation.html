{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_head %}
<style>
    .live-training-section {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-top: 2rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        border: 2px solid #e9ecef;
    }
    
    .live-training-content {
        margin-top: 1rem;
    }
    
    .live-metrics-table {
        margin: 2rem 0;
        width: 100%;
    }
    
    .metrics-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 3rem;
        margin: 0 auto;
    }
    
    .metrics-table td {
        width: 50%;
        padding: 0;
        text-align: center;
        vertical-align: middle;
    }
    
    .metric-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 120px;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: #007bff;
        margin-bottom: 0.5rem;
    }
    
    .metric-label {
        font-size: 0.875rem;
        color: #6c757d;
        font-weight: 500;
        margin-bottom: 0.75rem;
        text-align: center;
    }
    
    .live-charts-container {
        margin: 2rem 0;
    }
    
    .chart-container {
        height: 400px;
        margin-bottom: 1rem;
        background: white;
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid #e9ecef;
    }
    
    .live-controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
    }
    
    .live-controls .btn {
        min-width: 120px;
    }
</style>
{% endblock %}

{% block content %}
<div class="simulation-container">
    <!-- Header -->
    <div class="simulation-header">
        <div class="breadcrumb">
            <a href="/" class="breadcrumb-item">Dashboard</a>
            <span class="breadcrumb-separator">/</span>
            <a href="/purpose/{{ purpose_key }}" class="breadcrumb-item">{{ purpose.name }}</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item active">{{ equation.name }}</span>
        </div>
        
        <div class="simulation-title">
            <h1><i class="{{ equation.icon }}" style="color: {{ equation.color }};"></i> {{ equation.name }}</h1>
            <p class="simulation-subtitle">Forward Problem Simulation - {{ purpose.name }}</p>
        </div>
    </div>

    <!-- Equation Info -->
    <div class="equation-info-section">
        <div class="equation-formula">
            <h3>Governing Equation:</h3>
            <div class="formula-display">{{ equation.formula }}</div>
        </div>
        <div class="equation-description">
            <p>{{ equation.description }}</p>
        </div>
    </div>

    <!-- Configuration Form -->
    <div class="configuration-section">
        <h2><i class="fas fa-cogs"></i> Simulation Configuration</h2>
        
        <form id="simulation-form" class="simulation-form">
            <!-- Neural Network Configuration -->
            <div class="config-section">
                <h3 class="section-header">
                    <i class="fas fa-brain"></i>
                    Neural Network Architecture
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="hidden_layers">Hidden Layers</label>
                        <input type="number" id="hidden_layers" name="hidden_layers" 
                               value="{{ default_params.hidden_layers|default(4) }}" 
                               min="2" max="10" required>
                        <small class="form-text">Number of hidden layers</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="neurons_per_layer">Neurons per Layer</label>
                        <input type="number" id="neurons_per_layer" name="neurons_per_layer" 
                               value="{{ default_params.neurons_per_layer|default(20) }}" 
                               min="10" max="100" required>
                        <small class="form-text">Neurons in each hidden layer</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="hidden_activation">Hidden Layers Activation</label>
                        <select id="hidden_activation" name="hidden_activation" required>
                            <option value="tanh" selected>tanh - Hyperbolic Tangent (Recommended)</option>
                            <option value="sin">sin - Sine Function (High-frequency problems)</option>
                            <option value="softplus">softplus - Smooth ReLU Alternative</option>
                            <option value="sigmoid">sigmoid - Sigmoid Function</option>
                            <option value="relu">relu - ReLU (Not recommended for PINNs)</option>
                        </select>
                        <small class="form-text">Activation function for hidden layers (must be smooth for PDEs)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="output_activation">Output Layer Activation</label>
                        <select id="output_activation" name="output_activation" required>
                            <option value="linear" selected>linear - No Activation (Standard)</option>
                            <option value="tanh">tanh - Bounded (-1 to 1)</option>
                            <option value="sigmoid">sigmoid - Bounded (0 to 1)</option>
                            <option value="softplus">softplus - Positive (≥ 0)</option>
                        </select>
                        <small class="form-text">Activation function for output layer</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="optimizer">Optimizer</label>
                        <select id="optimizer" name="optimizer" required>
                            <option value="adam_lbfgs" selected>Adam → L-BFGS (Best Practice)</option>
                            <option value="adam">Adam (Fast initial convergence)</option>
                            <option value="lbfgs">L-BFGS (High precision)</option>
                            <option value="sgd">SGD (Not recommended for PINNs)</option>
                        </select>
                        <small class="form-text">Optimization algorithm</small>
                    </div>
                </div>
                
                <!-- Architecture Recommendations -->
                <div class="recommendation-box">
                    <h4><i class="fas fa-lightbulb"></i> Architecture Recommendations for {{ purpose.name }}</h4>
                    <div class="recommendation-content">
                        <p><strong>Hidden Activation:</strong> TANH</p>
                        <p><strong>Output Activation:</strong> LINEAR</p>
                        <p><strong>Optimizer:</strong> ADAM_LBFGS</p>
                        <p><strong>Notes:</strong> Smooth hidden activations + linear output + L-BFGS for PDE solving</p>
                    </div>
                </div>
            </div>

            <!-- Training Configuration -->
            <div class="config-section">
                <h3 class="section-header">
                    <i class="fas fa-graduation-cap"></i>
                    Training Parameters
                </h3>
                
                <!-- Basic Training Parameters -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="learning_rate">Learning Rate</label>
                        <input type="number" id="learning_rate" name="learning_rate" 
                               value="{{ default_params.learning_rate|default(0.001) }}" 
                               step="0.0001" min="0.0001" max="0.1" required>
                        <small class="form-text">Step size for gradient updates</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="epochs">Training Epochs</label>
                        <input type="number" id="epochs" name="epochs" 
                               value="{{ default_params.epochs|default(500) }}" 
                               min="100" max="10000" required>
                        <small class="form-text">Number of full training iterations (500 for testing, 1000+ for production)</small>
                    </div>
                </div>
                
                <!-- Advanced Training Parameters -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="learning_rate_scheduler">Learning Rate Scheduler</label>
                        <select id="learning_rate_scheduler" name="learning_rate_scheduler" required>
                            <option value="constant" selected>Constant (Fixed LR)</option>
                            <option value="step">Step Decay</option>
                            <option value="cosine">Cosine Annealing</option>
                            <option value="exponential">Exponential Decay</option>
                        </select>
                        <small class="form-text">How learning rate changes during training</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="weight_init">Weight Initialization</label>
                        <select id="weight_init" name="weight_init" required>
                            <option value="xavier" selected>Xavier/Glorot (Recommended)</option>
                            <option value="normal">Normal Distribution</option>
                            <option value="uniform">Uniform Distribution</option>
                            <option value="he">He (Not recommended for PINNs)</option>
                        </select>
                        <small class="form-text">Initial weight distribution strategy</small>
                    </div>
                </div>
                
                <!-- Scheduler Parameters (conditionally shown) -->
                <div id="scheduler-params" class="form-row" style="display: none;">
                    <div class="form-group">
                        <label for="scheduler_step_size">Scheduler Step Size</label>
                        <input type="number" id="scheduler_step_size" name="scheduler_step_size" 
                               value="1000" min="100" max="10000">
                        <small class="form-text">Epochs between LR reductions</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="scheduler_gamma">Scheduler Gamma</label>
                        <input type="number" id="scheduler_gamma" name="scheduler_gamma" 
                               value="0.9" step="0.1" min="0.1" max="1.0">
                        <small class="form-text">LR reduction factor</small>
                    </div>
                </div>
                
                <!-- Training Control -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="gradient_clipping">Gradient Clipping</label>
                        <input type="number" id="gradient_clipping" name="gradient_clipping" 
                               value="" step="0.1" min="0.1" max="10.0" placeholder="None (disabled)">
                        <small class="form-text">Max gradient norm (prevents exploding gradients)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="early_stopping_patience">Early Stopping Patience</label>
                        <input type="number" id="early_stopping_patience" name="early_stopping_patience" 
                               value="1000" min="100" max="5000">
                        <small class="form-text">Epochs to wait before stopping</small>
                    </div>
                </div>
                
                <!-- Loss Weights (PINN-specific) -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="physics_weight">Physics Loss Weight</label>
                        <input type="number" id="physics_weight" name="physics_weight" 
                               value="1.0" step="0.1" min="0.1" max="10.0" required>
                        <small class="form-text">Weight for PDE residual loss</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="boundary_weight">Boundary Loss Weight</label>
                        <input type="number" id="boundary_weight" name="boundary_weight" 
                               value="1.0" step="0.1" min="0.1" max="10.0" required>
                        <small class="form-text">Weight for boundary condition loss</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="initial_weight">Initial Condition Weight</label>
                        <input type="number" id="initial_weight" name="initial_weight" 
                               value="1.0" step="0.1" min="0.1" max="10.0" required>
                        <small class="form-text">Weight for initial condition loss</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="data_weight">Data Loss Weight</label>
                        <input type="number" id="data_weight" name="data_weight" 
                               value="1.0" step="0.1" min="0.1" max="10.0">
                        <small class="form-text">Weight for data fitting loss (inverse problems)</small>
                    </div>
                </div>
                
                <!-- Sampling Strategy -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="n_interior_points">Interior Points</label>
                        <input type="number" id="n_interior_points" name="n_interior_points" 
                               value="1000" min="100" max="10000" required>
                        <small class="form-text">Collocation points for PDE</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="n_boundary_points">Boundary Points</label>
                        <input type="number" id="n_boundary_points" name="n_boundary_points" 
                               value="200" min="50" max="2000" required>
                        <small class="form-text">Points for boundary conditions</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="n_initial_points">Initial Points</label>
                        <input type="number" id="n_initial_points" name="n_initial_points" 
                               value="200" min="50" max="2000" required>
                        <small class="form-text">Points for initial conditions</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="n_data_points">Data Points</label>
                        <input type="number" id="n_data_points" name="n_data_points" 
                               value="" min="10" max="1000" placeholder="None">
                        <small class="form-text">Observed data points (inverse problems)</small>
                    </div>
                </div>
                
                <div class="recommendation-box">
                    <h4><i class="fas fa-lightbulb"></i> Training Recommendations for {{ purpose.name }}</h4>
                    <div class="recommendation-content">
                        <p><strong>Learning Rate:</strong> 0.001</p>
                        <p><strong>Scheduler:</strong> Constant</p>
                        <p><strong>Loss Weights:</strong> Physics=1.0, Boundary=1.0, Initial=1.0</p>
                        <p><strong>Sampling:</strong> Interior=1000, Boundary=200, Initial=200</p>
                        <p><strong>Notes:</strong> Standard PINN training with balanced loss weights</p>
                    </div>
                </div>
            </div>

            <!-- Equation-specific parameters -->
            <div class="config-section">
                <h3 class="section-header">
                    <i class="fas fa-calculator"></i>
                    {{ equation.name }} Parameters
                </h3>
                
                <!-- Dynamic equation-specific parameters in two columns -->
                <div class="parameters-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                    {% for param_id, param_info in parameters.items() %}
                        {% if param_info is mapping and param_info.name and param_info.default is defined %}
                        <div class="parameter-item" style="background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 1.5rem; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                            <label for="{{ param_id }}" style="display: block; font-weight: 700; color: #2c3e50; margin-bottom: 0.75rem; font-size: 1rem; line-height: 1.3;">{{ param_info.name }}</label>
                            <input type="number" id="{{ param_id }}" name="{{ param_id }}" 
                                   value="{{ default_params[param_id]|default(param_info.default) }}" 
                                   step="{{ param_info.step|default(0.01) }}" 
                                   min="{{ param_info.range[0]|default(0.0) }}" 
                                   max="{{ param_info.range[1]|default(10.0) }}" required
                                   style="width: 100%; padding: 1rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; font-weight: 500; transition: all 0.3s ease; background: #f8f9fa; color: #2c3e50;">
                            <small class="form-text" style="font-size: 0.875rem; color: #6c757d; margin-top: 0.5rem; line-height: 1.5; display: block;">{{ param_info.description }}</small>
                            {% if param_info.unit %}
                            <small class="form-text text-muted" style="color: #adb5bd; font-style: italic; font-size: 0.8rem; margin-top: 0.25rem;">Unit: {{ param_info.unit }}</small>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                
                <!-- Time Parameters Section -->
                <div class="time-parameters-section" style="margin-top: 2.5rem; padding-top: 2rem; border-top: 3px solid #e9ecef; background: #f8f9fa; border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
                    <h4 class="subsection-header" style="font-size: 1.25rem; font-weight: 700; color: #2c3e50; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; padding-bottom: 0.75rem; border-bottom: 2px solid #3498db;">
                        <i class="fas fa-clock" style="color: #17a2b8; font-size: 1.1rem;"></i>
                        Time Domain Parameters
                    </h4>
                    <div class="parameters-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                        <div class="parameter-item" style="background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 1.5rem; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                            <label for="time_duration" style="display: block; font-weight: 700; color: #2c3e50; margin-bottom: 0.75rem; font-size: 1rem; line-height: 1.3;">Time Duration (T)</label>
                            <input type="number" id="time_duration" name="time_duration" 
                                   value="{{ default_params.time_duration|default(1.0) }}" 
                                   step="0.1" min="0.1" max="100.0" required
                                   style="width: 100%; padding: 1rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; font-weight: 500; transition: all 0.3s ease; background: #f8f9fa; color: #2c3e50;">
                            <small class="form-text" style="font-size: 0.875rem; color: #6c757d; margin-top: 0.5rem; line-height: 1.5; display: block;">Total simulation time (t ∈ [0, T])</small>
                            <small class="form-text text-muted" style="color: #adb5bd; font-style: italic; font-size: 0.8rem; margin-top: 0.25rem;">Unit: s</small>
                        </div>
                        
                        <div class="parameter-item" style="background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 1.5rem; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                            <label for="time_points" style="display: block; font-weight: 700; color: #2c3e50; margin-bottom: 0.75rem; font-size: 1rem; line-height: 1.3;">Time Sampling Points (N_t)</label>
                            <input type="number" id="time_points" name="time_points" 
                                   value="{{ default_params.time_points|default(100) }}" 
                                   min="10" max="1000" required
                                   style="width: 100%; padding: 1rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; font-weight: 500; transition: all 0.3s ease; background: #f8f9fa; color: #2c3e50;">
                            <small class="form-text" style="font-size: 0.875rem; color: #6c757d; margin-top: 0.5rem; line-height: 1.5; display: block;">Number of time steps for collocation</small>
                            <small class="form-text text-muted" style="color: #adb5bd; font-style: italic; font-size: 0.8rem; margin-top: 0.25rem;">Unit: dimensionless</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Boundary and Initial Conditions -->
            <div class="config-section">
                <h3 class="section-header">
                    <i class="fas fa-border-all"></i>
                    Boundary & Initial Conditions
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="initial_condition">Initial Condition Type</label>
                        <select id="initial_condition" name="initial_condition" required>
                            <option value="sinusoidal" selected>Sinusoidal (sin(πx/L))</option>
                            <option value="gaussian">Gaussian</option>
                            <option value="step">Step Function</option>
                            <option value="custom">Custom Function</option>
                        </select>
                        <small class="form-text">Initial condition u(x,0)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="boundary_condition">Boundary Condition Type</label>
                        <select id="boundary_condition" name="boundary_condition" required>
                            <option value="dirichlet" selected>Dirichlet (Fixed Values)</option>
                            <option value="neumann">Neumann (Fixed Derivatives)</option>
                            <option value="periodic">Periodic</option>
                            <option value="mixed">Mixed</option>
                        </select>
                        <small class="form-text">Boundary conditions at x=0 and x=L</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="left_boundary_value">Left Boundary Value</label>
                        <input type="number" id="left_boundary_value" name="left_boundary_value" 
                               value="0.0" step="0.1" required>
                        <small class="form-text">u(0,t) value</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="right_boundary_value">Right Boundary Value</label>
                        <input type="number" id="right_boundary_value" name="right_boundary_value" 
                               value="0.0" step="0.1" required>
                        <small class="form-text">u(L,t) value</small>
                    </div>
                </div>
            </div>

            <!-- Sampling Strategy -->
            <div class="config-section">
                <h3 class="section-header">
                    <i class="fas fa-dice"></i>
                    Sampling Strategy
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="sampling_method">Sampling Method</label>
                        <select id="sampling_method" name="sampling_method" required>
                            <option value="uniform" selected>Uniform Grid</option>
                            <option value="random">Random Sampling</option>
                            <option value="latin_hypercube">Latin Hypercube</option>
                            <option value="sobol">Sobol Sequence</option>
                            <option value="adaptive">Adaptive Sampling</option>
                        </select>
                        <small class="form-text">Method for generating collocation points</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="adaptive_sampling">Adaptive Sampling</label>
                        <select id="adaptive_sampling" name="adaptive_sampling" required>
                            <option value="false" selected>Disabled</option>
                            <option value="true">Enabled (Advanced)</option>
                        </select>
                        <small class="form-text">Dynamically adjust sampling based on error</small>
                    </div>
                </div>
            </div>

            <!-- Validation Configuration -->
            <div class="config-section">
                <h3 class="section-header">
                    <i class="fas fa-chart-line"></i>
                    Validation & Testing
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="validation_split">Validation Split (%)</label>
                        <input type="number" id="validation_split" name="validation_split" 
                               value="20" min="5" max="50" required>
                        <small class="form-text">Percentage of data for validation</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="test_points">Test Points</label>
                        <input type="number" id="test_points" name="test_points" 
                               value="500" min="100" max="2000" required>
                        <small class="form-text">Points for final error evaluation</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="error_metrics">Error Metrics</label>
                        <select id="error_metrics" name="error_metrics" multiple required>
                            <option value="l2_norm" selected>L2 Norm</option>
                            <option value="relative_error" selected>Relative Error</option>
                            <option value="rmse">RMSE</option>
                            <option value="mae">MAE</option>
                            <option value="max_error">Maximum Error</option>
                        </select>
                        <small class="form-text">Metrics to compute for evaluation</small>
                    </div>
                </div>
            </div>

            <!-- Advanced Configuration -->
            <div class="config-section">
                <h3 class="section-header">
                    <i class="fas fa-cogs"></i>
                    Advanced Configuration
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="random_seed">Random Seed</label>
                        <input type="number" id="random_seed" name="random_seed" 
                               value="42" min="0" max="999999">
                        <small class="form-text">For reproducible results</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="checkpoint_frequency">Checkpoint Frequency</label>
                        <input type="number" id="checkpoint_frequency" name="checkpoint_frequency" 
                               value="1000" min="100" max="10000">
                        <small class="form-text">Save model every N epochs</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="pde_residual_scaling">PDE Residual Scaling</label>
                        <select id="pde_residual_scaling" name="pde_residual_scaling" required>
                            <option value="none" selected>None</option>
                            <option value="domain_size">Domain Size</option>
                            <option value="adaptive">Adaptive</option>
                        </select>
                        <small class="form-text">Scale PDE residuals for better balance</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="multi_fidelity">Multi-Fidelity Training</label>
                        <select id="multi_fidelity" name="multi_fidelity" required>
                            <option value="false" selected>Single Fidelity</option>
                            <option value="true">Multi-Fidelity (Advanced)</option>
                        </select>
                        <small class="form-text">Use multiple resolution levels</small>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-large">
                    <i class="fas fa-play"></i>
                    Start Training
                </button>
                <button type="button" class="btn btn-outline-primary btn-large" onclick="startTrainingWithLiveView()">
                    <i class="fas fa-chart-line"></i>
                    Start Training with Live View
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                    <i class="fas fa-undo"></i>
                    Reset to Defaults
                </button>
            </div>
        </form>
    </div>

    <!-- Live Training Monitor -->
    <div id="live-training-monitor" class="live-training-section" style="display: none;">
        <h2><i class="fas fa-chart-line"></i> Live Training Monitor</h2>
        <div class="live-training-content">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Live Training Active:</strong> Training is running in the background. Monitor progress in real-time below.
            </div>
            
            <div class="live-metrics-table">
                <table class="metrics-table">
                    <tr>
                        <td class="metric-card">
                            <div class="metric-label">Total Loss</div>
                            <div class="metric-value" id="liveTotalLoss">-</div>
                        </td>
                        <td class="metric-card">
                            <div class="metric-label">Physics Loss</div>
                            <div class="metric-value" id="livePhysicsLoss">-</div>
                        </td>
                    </tr>
                    <tr>
                        <td class="metric-card">
                            <div class="metric-label">Boundary Loss</div>
                            <div class="metric-value" id="liveBoundaryLoss">-</div>
                        </td>
                        <td class="metric-card">
                            <div class="metric-label">Initial Loss</div>
                            <div class="metric-value" id="liveInitialLoss">-</div>
                        </td>
                    </tr>
                </table>
            </div>
            
            <div class="live-charts-container">
                <div class="chart-container">
                    <canvas id="liveLossChart"></canvas>
                </div>
            </div>
            
            <div class="live-controls">
                <button type="button" class="btn btn-outline-danger" id="stopLiveTraining">
                    <i class="fas fa-stop"></i> Stop Training
                </button>
                <button type="button" class="btn btn-outline-secondary" id="resetLiveTraining">
                    <i class="fas fa-redo"></i> Reset
                </button>
                <button type="button" class="btn btn-success" id="viewResults" style="display: none;">
                    <i class="fas fa-chart-bar"></i> View Results
                </button>
            </div>
        </div>
    </div>

    <!-- Training Progress -->
    <div id="training-progress" class="training-progress-section" style="display: none;">
        <h2><i class="fas fa-chart-line"></i> Training Progress</h2>
        <div class="progress-container">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <div class="progress-text">
                <span id="progress-percentage">0%</span>
                <span id="progress-epochs">Epoch 0 / 0</span>
            </div>
        </div>
        <div class="loss-display">
            <div class="loss-item">
                <span class="loss-label">Physics Loss:</span>
                <span id="physics-loss" class="loss-value">-</span>
            </div>
            <div class="loss-item">
                <span class="loss-label">Boundary Loss:</span>
                <span id="boundary-loss" class="loss-value">-</span>
            </div>
            <div class="loss-item">
                <span class="loss-label">Total Loss:</span>
                <span id="total-loss" class="loss-value">-</span>
            </div>
        </div>
    </div>

    <!-- Results Preview -->
    <div id="results-preview" class="results-preview-section" style="display: none;">
        <h2><i class="fas fa-chart-area"></i> Results Preview</h2>
        <div class="results-grid">
            <div class="result-card">
                <h4>Loss History</h4>
                <div id="loss-chart" class="chart-container"></div>
            </div>
            <div class="result-card">
                <h4>Solution Comparison</h4>
                <div id="solution-chart" class="chart-container"></div>
            </div>
        </div>
        <div class="results-actions">
            <a href="/purpose/{{ purpose_key }}/results/{{ eq_type }}" class="btn btn-primary">
                <i class="fas fa-chart-bar"></i>
                View Detailed Results
            </a>
            <button type="button" class="btn btn-outline-primary" onclick="downloadResults()">
                <i class="fas fa-download"></i>
                Download Results
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/simulation.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Purpose-specific simulation configuration - make it global
    window.purposeKey = "{{ purpose_key }}";
    window.purposeName = "{{ purpose.name }}";
    window.equationType = "{{ eq_id }}";
    
    // Log configuration for debugging
    console.log('Simulation page loaded for:', window.purposeName, window.equationType);
    console.log('Purpose Key:', window.purposeKey);
    
    // Live Training Variables
    let liveTrainingChart = null;
    let isLiveTraining = false;
    let liveTrainingInterval = null;
    let currentEpoch = 0;
    let totalEpochs = 0;
    let trainingCompleted = false; // Flag to prevent multiple completion alerts
    
    // Initialize live training chart
    function initializeLiveChart() {
        const ctx = document.getElementById('liveLossChart').getContext('2d');
        liveTrainingChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Total Loss',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1
                }, {
                    label: 'Physics Loss',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.1
                }, {
                    label: 'Boundary Loss',
                    data: [],
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.1
                }, {
                    label: 'Initial Loss',
                    data: [],
                    borderColor: 'rgb(255, 159, 64)',
                    backgroundColor: 'rgba(255, 159, 64, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Live Training Progress'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                animation: {
                    duration: 0
                }
            }
        });
    }
    
    // Start live training simulation
    function startLiveTraining() {
        if (isLiveTraining) return;
        
        // Get form data
        const form = document.getElementById('simulation-form');
        const formData = new FormData(form);
        
        // Convert form data to JSON
        const trainingData = {};
        for (let [key, value] of formData.entries()) {
            if (value === '') {
                if (key === 'gradient_clipping' || key === 'n_data_points') {
                    trainingData[key] = null;
                } else {
                    trainingData[key] = undefined;
                }
            } else {
                if (['hidden_layers', 'neurons_per_layer', 'epochs', 'batch_size'].includes(key)) {
                    trainingData[key] = parseInt(value);
                } else if (['learning_rate'].includes(key)) {
                    trainingData[key] = parseFloat(value);
                } else {
                    trainingData[key] = value;
                }
            }
        }
        
        // Add required fields
        trainingData.equation_type = '{{ eq_id }}';
        trainingData.purpose = '{{ purpose_key }}';
        
        // Store training data in sessionStorage
        sessionStorage.setItem('trainingData', JSON.stringify(trainingData));
        
        // Initialize live training
        isLiveTraining = true;
        trainingCompleted = false; // Reset completion flag
        currentEpoch = 0;
        totalEpochs = trainingData.epochs || 1000;
        
        // Hide View Results button when starting new training
        document.getElementById('viewResults').style.display = 'none';
        
        // Show live training monitor
        document.getElementById('live-training-monitor').style.display = 'block';
        
        // Initialize chart if not already done
        if (!liveTrainingChart) {
            initializeLiveChart();
        }
        
        // Start polling IMMEDIATELY (don't wait for training to start)
        console.log('🚀 Starting real-time polling for backend data...');
        liveTrainingInterval = setInterval(async () => {
            try {
                const response = await fetch(`/api/training-progress/{{ purpose_key }}/{{ eq_id }}`);
                const progress = await response.json();
                
                console.log('Backend progress:', progress);
                console.log('Progress status:', progress?.status);
                console.log('Current epoch:', progress?.current_epoch);
                console.log('Total loss:', progress?.total_loss);
                console.log('Progress keys:', Object.keys(progress || {}));
                console.log('Is training status?', progress?.status === 'training');
                console.log('Has current epoch?', progress?.current_epoch !== undefined && progress?.current_epoch > 0);
                
                // Check if we have any progress data
                if (progress && progress.status) {
                    if (progress.status === 'completed') {
                        // Backend training is complete
                        clearInterval(liveTrainingInterval);
                        liveTrainingInterval = null;
                        isLiveTraining = false;
                        
                        console.log('🎉 Training completed! Final results:', progress);
                        
                        // Update with final backend values
                        if (progress.total_loss !== undefined) {
                            document.getElementById('liveTotalLoss').textContent = progress.total_loss.toFixed(4);
                            document.getElementById('livePhysicsLoss').textContent = progress.physics_loss.toFixed(4);
                            document.getElementById('liveBoundaryLoss').textContent = progress.boundary_loss.toFixed(4);
                            document.getElementById('liveInitialLoss').textContent = progress.initial_loss.toFixed(4);
                            
                            // Update chart with final point if not already added
                            const finalEpoch = progress.current_epoch || totalEpochs;
                            const epochIndex = liveTrainingChart.data.labels.indexOf(finalEpoch);
                            if (epochIndex === -1) {
                                liveTrainingChart.data.labels.push(finalEpoch);
                                liveTrainingChart.data.datasets[0].data.push(progress.total_loss);
                                liveTrainingChart.data.datasets[1].data.push(progress.physics_loss);
                                liveTrainingChart.data.datasets[2].data.push(progress.boundary_loss);
                                liveTrainingChart.data.datasets[3].data.push(progress.initial_loss);
                                liveTrainingChart.update();
                            }
                        }
                        
                        // Only show completion alert once
                        if (!trainingCompleted) {
                            trainingCompleted = true;
                            alert('Live training completed successfully!');
                            
                            // Show View Results button
                            document.getElementById('viewResults').style.display = 'inline-block';
                        }
                        return;
                    } else if (progress.status === 'training') {
                        // Backend training is running, update with real data
                        if (progress.current_epoch !== undefined && progress.current_epoch > 0) {
                            currentEpoch = progress.current_epoch;
                            
                            console.log(`🔄 Updating frontend with epoch ${progress.current_epoch}:`, {
                                total_loss: progress.total_loss,
                                physics_loss: progress.physics_loss,
                                boundary_loss: progress.boundary_loss,
                                initial_loss: progress.initial_loss
                            });
                            
                            // Update metrics with real backend values
                            document.getElementById('liveTotalLoss').textContent = progress.total_loss.toFixed(4);
                            document.getElementById('livePhysicsLoss').textContent = progress.physics_loss.toFixed(4);
                            document.getElementById('liveBoundaryLoss').textContent = progress.boundary_loss.toFixed(4);
                            document.getElementById('liveInitialLoss').textContent = progress.initial_loss.toFixed(4);
                            
                            // Update chart with real data (always update for real-time feel)
                            // Check if this epoch is new or if we should update existing
                            const epochIndex = liveTrainingChart.data.labels.indexOf(progress.current_epoch);
                            if (epochIndex === -1) {
                                // New epoch, add to chart
                                liveTrainingChart.data.labels.push(progress.current_epoch);
                                liveTrainingChart.data.datasets[0].data.push(progress.total_loss);
                                liveTrainingChart.data.datasets[1].data.push(progress.physics_loss);
                                liveTrainingChart.data.datasets[2].data.push(progress.boundary_loss);
                                liveTrainingChart.data.datasets[3].data.push(progress.initial_loss);
                            } else {
                                // Update existing epoch data
                                liveTrainingChart.data.datasets[0].data[epochIndex] = progress.total_loss;
                                liveTrainingChart.data.datasets[1].data[epochIndex] = progress.physics_loss;
                                liveTrainingChart.data.datasets[2].data[epochIndex] = progress.boundary_loss;
                                liveTrainingChart.data.datasets[3].data[epochIndex] = progress.initial_loss;
                            }
                            liveTrainingChart.update('none'); // Disable animations for real-time updates
                        } else {
                            // Training started but no epoch data yet
                            document.getElementById('liveTotalLoss').textContent = 'Starting...';
                            document.getElementById('livePhysicsLoss').textContent = 'Starting...';
                            document.getElementById('liveBoundaryLoss').textContent = 'Starting...';
                            document.getElementById('liveInitialLoss').textContent = 'Starting...';
                        }
                    } else {
                        // Backend training not started yet, show initial state
                        document.getElementById('liveTotalLoss').textContent = 'Waiting...';
                        document.getElementById('livePhysicsLoss').textContent = 'Waiting...';
                        document.getElementById('liveBoundaryLoss').textContent = 'Waiting...';
                        document.getElementById('liveInitialLoss').textContent = 'Waiting...';
                    }
                } else {
                    // No progress data available
                    document.getElementById('liveTotalLoss').textContent = 'No data';
                    document.getElementById('livePhysicsLoss').textContent = 'No data';
                    document.getElementById('liveBoundaryLoss').textContent = 'No data';
                    document.getElementById('liveInitialLoss').textContent = 'No data';
                }
                
            } catch (error) {
                console.log('Could not fetch backend progress:', error);
                // Show loading state
                document.getElementById('liveTotalLoss').textContent = 'Error';
                document.getElementById('livePhysicsLoss').textContent = 'Error';
                document.getElementById('liveBoundaryLoss').textContent = 'Error';
                document.getElementById('liveInitialLoss').textContent = 'Error';
            }
        }, 200); // Poll every 200ms for more responsive real-time updates
        
        // Send training request to backend (non-blocking) AFTER starting polling
        fetch('/api/simulate/{{ purpose_key }}/{{ eq_id }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(trainingData)
        }).then(response => {
            if (response.ok) {
                console.log('Backend training started successfully');
            } else {
                console.error('Failed to start backend training');
            }
        });
    }
    
    // Stop live training
    function stopLiveTraining() {
        if (!isLiveTraining) return;
        
        isLiveTraining = false;
        if (liveTrainingInterval) {
            clearInterval(liveTrainingInterval);
            liveTrainingInterval = null;
        }
        
        // Hide live training monitor
        document.getElementById('live-training-monitor').style.display = 'none';
        
        console.log('Live training stopped');
    }
    
    // Reset live training
    function resetLiveTraining() {
        stopLiveTraining();
        
        if (liveTrainingChart) {
            liveTrainingChart.data.labels = [];
            liveTrainingChart.data.datasets.forEach(dataset => dataset.data = []);
            liveTrainingChart.update();
        }
        
        // Reset metrics
        document.getElementById('liveTotalLoss').textContent = '-';
        document.getElementById('livePhysicsLoss').textContent = '-';
        document.getElementById('liveBoundaryLoss').textContent = '-';
        document.getElementById('liveInitialLoss').textContent = '-';
        
        currentEpoch = 0;
        totalEpochs = 0;
    }
    
    // View detailed results
    function viewResults() {
        // Navigate to the results page using the correct URL format
        window.location.href = `/purpose/${window.purposeKey}/results/${window.equationType}`;
    }
    
    // Event listeners for live training controls
    document.addEventListener('DOMContentLoaded', function() {
        // Override the existing startTrainingWithLiveView function
        window.startTrainingWithLiveView = startLiveTraining;
        
        // Add event listeners for live training controls
        document.getElementById('stopLiveTraining').addEventListener('click', stopLiveTraining);
        document.getElementById('resetLiveTraining').addEventListener('click', resetLiveTraining);
        document.getElementById('viewResults').addEventListener('click', viewResults);
    });
</script>
{% endblock %} 